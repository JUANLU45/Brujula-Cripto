ü§ñ Br√∫jula Cripto: Plan de Arquitectura - Miniservicio de Chatbot Cripto-Especialista (V2)

1. Visi√≥n General y Prop√≥sito Este documento detalla la arquitectura de un miniservicio
   completamente independiente y robusto que alojar√° a un chatbot especialista en criptomonedas. El
   servicio funcionar√° bajo un modelo Freemium y se integrar√° con la plataforma principal de Br√∫jula
   Cripto. Principios Clave:

Aislamiento: El servicio se ejecuta de forma independiente para no afectar al rendimiento de la
aplicaci√≥n principal. Escalabilidad: Construido sobre infraestructura serverless para manejar
cualquier nivel de carga. Inteligencia Real: El chatbot no solo responde, sino que "aprende" a
trav√©s de RAG (Retrieval-Augmented Generation) y puede interactuar con datos de la blockchain en
tiempo real.

2. Arquitectura T√©cnica Detallada El servicio se construir√° sobre Google Cloud, manteniendo la
   coherencia con el resto del ecosistema.

Hosting del Servicio: Google Cloud Run. Orquestaci√≥n de IA: Genkit for Firebase. Modelo de Lenguaje
(LLM): Google Gemini Pro. Base de Datos de Conversaciones: Cloud Firestore. Base de Conocimiento
("Aprendizaje"): Vertex AI Vector Search. Aqu√≠ es donde el chatbot "aprende", indexando
documentaci√≥n t√©cnica, whitepapers y gu√≠as de seguridad para dar respuestas expertas (RAG). Conexi√≥n
a la Blockchain (Herramientas): El chatbot usar√° "Tools" de Genkit para interactuar con APIs
externas (ej. Covalent, Moralis, GoPlus Security). Las herramientas ser√°n:

getWalletAnalysis(address, chain): Devuelve el balance, tokens, NFTs y un an√°lisis de riesgos.
getTransactionStatus(txHash, chain): Verifica el estado de una transacci√≥n.
getContractAuditSummary(contractAddress, chain): Obtiene un resumen de la seguridad de un contrato.

3. Modelo de Datos en Firestore (Dedicado al Chatbot)

Colecci√≥n chatbot_conversations:

Campos: userId, title, isFavorite, createdAt, updatedAt.

Sub-colecci√≥n chatbot_messages:

Anidada dentro de cada conversaci√≥n. Campos: role ('user' | 'model'), content, timestamp.

4. Funcionalidades de Usuario y Flujo de Interacci√≥n El frontend (packages/app) tendr√° una nueva
   secci√≥n para el chatbot que interactuar√° con el miniservicio a trav√©s de una API REST.

Endpoints de la API: GET /conversations, POST /conversations, PUT /conversations/{id}, DELETE
/conversations/{id}, POST /conversations/{id}/messages (con streaming). Panel de Usuario del
Chatbot: Una barra lateral con la lista de conversaciones (crear, renombrar, favorito, borrar) y la
ventana de chat principal.

5. Modelo de Monetizaci√≥n y Propuesta de Valor La suscripci√≥n hasPremiumChatAccess desbloquea el
   valor real del chatbot: el an√°lisis proactivo de la blockchain. A. El Valor para el Usuario
   Gratuito (El Anzuelo üé£) El usuario gratuito obtiene un experto en cripto para consultas
   generales. Cuando pide un an√°lisis de wallet, el chatbot le ofrece una "demostraci√≥n" limitada
   para engancharlo.

Respuesta Gratuita: "He identificado que la direcci√≥n 0x123... es una wallet v√°lida en Ethereum.
Para realizar un an√°lisis completo en tiempo real, incluyendo el valor de tu portafolio, desglose de
tokens/NFTs y un informe de riesgos de seguridad, necesitas acceso Premium. ¬øQuieres saber m√°s?"

B. El Valor para el Usuario de Pago (La Soluci√≥n Completa üõ°Ô∏è) El usuario de pago obtiene un analista
de seguridad personal. El chatbot le entrega un informe completo y accionable.

Respuesta Premium: "Claro. Aqu√≠ tienes el an√°lisis de tu wallet:

Valor Total: 1,250.45 ‚Ç¨ Activos: 150.2 MATIC, 0.25 WETH, 500.10 USDC... NFTs: 2 de la colecci√≥n
"CryptoPunks Polygon". üö® ¬°AN√ÅLISIS DE RIESGOS! üö®

¬°Atenci√≥n! Aprobaci√≥n de Contrato de Riesgo: Tienes una aprobaci√≥n ilimitada para el contrato
0x789.... Este contrato podr√≠a retirar todos tus WETH. Se recomienda revocar este permiso
inmediatamente."

El valor es la claridad financiera y, sobre todo, la seguridad proactiva que puede evitar p√©rdidas
catastr√≥ficas.

6. Integraci√≥n con la Plataforma Existente

Frontend (packages/app): Se crear√° una nueva ruta /chatbot con los componentes de la interfaz
(ChatbotUI.tsx, ConversationList.tsx). El archivo lib/api.ts se ampliar√° para llamar a los endpoints
del nuevo miniservicio. Backend (packages/functions): Se a√±adir√°n las funciones de pago de Stripe
para la nueva suscripci√≥n, que modificar√°n el campo hasPremiumChatAccess en el perfil del usuario.
Tipos (packages/types): Se a√±adir√°n las nuevas interfaces: IChatConversation (EXPANDIDA 2025) y
IChatMessage.

### Estado Implementaci√≥n Chatbot (2025)

**‚úÖ COMPLETADO:**

- Expansi√≥n de `IChatConversation` en `packages/types` con funcionalidades profesionales
- Implementaci√≥n completa de `ConversationList.tsx` con:
  - Favoritos y organizaci√≥n avanzada
  - Tags para categorizaci√≥n
  - Edici√≥n inline de t√≠tulos
  - Confirmaci√≥n de eliminaci√≥n
  - UI mobile-first responsive
  - Soporte completo modo claro/oscuro
  - Internacionalizaci√≥n biling√ºe (es/en)
  - Integraci√≥n con tipos centralizados

**üîÑ PENDIENTE:**

- ChatbotUI.tsx para interfaz principal
- Endpoints API backend para conversaciones
- Integraci√≥n con sistema de cr√©ditos

7. Experiencia de Usuario (UX) Espectacular debe ser impecable:

Respuestas en Streaming: El chatbot escribir√° las respuestas palabra por palabra, como ChatGPT,
dando una sensaci√≥n de "pensamiento" en tiempo real y mejorando la percepci√≥n de velocidad.
Sugerencias de Preguntas: Al iniciar una nueva conversaci√≥n o despu√©s de una respuesta, el chatbot
sugerir√° preguntas de seguimiento relevantes. Ej: "¬øQuieres que analice los riesgos de este
contrato?", "¬øTe gustar√≠a saber m√°s sobre el token WETH?". Renderizado de Componentes: El chatbot no
solo devolver√° texto. Cuando genere un informe de wallet, el frontend renderizar√° componentes
visuales (tablas para tokens, tarjetas para NFTs) dentro del chat, haciendo la informaci√≥n mucho m√°s
digerible. Memoria a Corto y Largo Plazo: El chatbot recordar√° el contexto de la conversaci√≥n
actual. Adem√°s, a trav√©s de RAG, tendr√° acceso al conocimiento experto, simulando una memoria a
largo plazo. Claridad y Simplicidad: Todas las respuestas, incluso las m√°s t√©cnicas, se explicar√°n
en un lenguaje sencillo. El objetivo no es abrumar, sino empoderar al usuario. Dise√±o Espectacular:
Imagen principal de br√∫jula como icono/logo, nombre del chatbot "Br√∫jula" visible en header de
p√°gina.

8. Mejoras Implementadas para Robustez y Producci√≥n 2025 A. L√≠mites de Uso para Chatbot Gratuito

Descripci√≥n: En endpoints API, implementar l√≠mites: Usuarios gratuitos limitados a 10 mensajes/d√≠a,
usando Firestore para contar via userId. Si excede, retornar error 429 con mensaje upselling. No
altera flujos premium.

B. Integraci√≥n de Pago por Horas

Descripci√≥n: Reemplazar hasPremiumChatAccess por chequeo de usageCreditsInSeconds. En flujos de
interacci√≥n, llamar a trackUsage para descontar segundos durante uso. Cr√©dito inicial 1800s (30min)
para registrados. Upselling en respuestas gratuitas si cr√©ditos bajos.
