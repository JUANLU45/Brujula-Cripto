ü§ñ PROYECTO: Br√∫jula Cripto - Plan del Microservicio de Contenido IA (VERSI√ìN FINAL DE PRODUCCI√ìN)

1. Stack Tecnol√≥gico

Framework: Genkit for Firebase (TypeScript) Ejecuci√≥n: Google Cloud Run (Contenedor Docker) Modelo
IA: Gemini Pro (v√≠a Vertex AI) Trigger: Google Cloud Scheduler

2. L√≥gica y Centralizaci√≥n

Prompts Centralizados: Los prompts para Gemini estar√°n en archivos .txt (/src/prompts) para ser
mejorados sin tocar el c√≥digo. Tipos Compartidos: Importar√° IArticle y abstracciones de BD (IDatabaseAdapter) desde @br√∫jula-cripto/types.
Validaci√≥n Robusta: Se usar√° Zod para validar la salida final del LLM.

3. Flujo de Ejecuci√≥n Detallado - Actualizado para i18n

Trigger: Cloud Scheduler llama a la URL de Cloud Run. fetch-news: El flujo ejecuta la herramienta
newsApiTool. Manejo de Errores: Si falla, usa un tema "evergreen" de fallback. generate-content-es:
Carga el prompt, lo formatea para espa√±ol, y genera title, contentMarkdown, y excerpt en espa√±ol.
generate-content-en: Carga el prompt, lo formatea para ingl√©s, y genera title, contentMarkdown, y
excerpt en ingl√©s. generate-seo-metadata: Genera un slug √∫nico (independiente del idioma), category,
y tags basados en el contenido de ambos idiomas. check-slug-uniqueness: Consulta Firestore para
asegurar que el slug no existe. Si existe, a√±ade un sufijo. assemble-and-validate: Construye el
objeto IArticle final con los contenidos de es y en y los metadatos. Valida el objeto completo con
Zod. save-to-firestore: Si la validaci√≥n pasa, guarda el art√≠culo completo en la base de datos con
status: 'draft' y source: 'ai-generated'. 

**‚úÖ IMPORTANTE - ABSTRACCIONES DE BD**: Este microservicio debe usar las mismas abstracciones implementadas en el backend principal:
- **Importar**: `import { database } from '../lib/database'` (adaptar ruta)
- **Usar**: `await database.addDocument('articles', articleData)` 
- **No usar**: Llamadas directas a Firebase/Firestore
- **Seguir patr√≥n**: Misma arquitectura vendor-agnostic que Cloud Functions

Logging: Cada paso registra su estado en Google Cloud Logging.

4. Seguridad y Configuraci√≥n

Gesti√≥n de Secretos: Las claves de Vertex AI se inyectar√°n de forma segura en el entorno de Cloud
Run a trav√©s de Google Secret Manager. Variables de Entorno: La configuraci√≥n (Project ID, etc.) se
pasar√° al contenedor de Cloud Run en el momento del despliegue.

5. Mejoras Implementadas para Robustez y Producci√≥n 2025 A. Optimizaci√≥n de Carga en Vertex AI

Descripci√≥n: En flujo de ejecuci√≥n, a√±adir paso post-indexaci√≥n: Optimizar √≠ndice en Vertex AI
priorizando documentos de alta relevancia (basado en frecuencia de uso), con limpieza peri√≥dica
semanal via Scheduler. A√±adir en logging: Registro de tama√±o de √≠ndice para monitoreo.

B. Validaci√≥n de Respuestas T√©cnicas

Descripci√≥n: Despu√©s de assemble-and-validate, a√±adir paso audit-responses: Implementar auditor√≠a
automatizada usando Zod para precisi√≥n t√©cnica, con fallback a revisi√≥n manual si score <90%.
Integrar en flujo sin alterar validaci√≥n Zod existente.

C. Generaci√≥n SEO Automatizada

Descripci√≥n: En generate-seo-metadata, generar metaetiquetas din√°micas (title, description,
keywords) enfocadas a SEO 2025 (usando schema.org, mobile-first indexing). Categor√≠as/tags
din√°micos, editables desde admin. Para posts autom√°ticos, opci√≥n en admin para foto (s√≠/no), enlace
afiliado, programaci√≥n de publicaci√≥n.

D. Moderaci√≥n Autom√°tica de Comentarios

Descripci√≥n: Nuevo flujo moderateComment: Analiza comentarios nuevos con OpenAI Moderation o Google
Perspective API. Marcar para revisi√≥n o eliminar autom√°ticamente basado en config admin (almacenada
en Firestore). Trigger por writes en subcolecci√≥n comments.

E. Adaptaci√≥n para Uso Externo

Descripci√≥n: A√±adir endpoints API para embed en otras webs (ej. GET /articles?siteKey=xxx).
Monetizar v√≠a suscripciones API (verificar key en Firestore, limitar por quota). M√≠nimos cambios:
A√±adir param siteKey en queries, sin alterar flujos internos.
