ğŸ—„ï¸ PROYEC_PARTE3_FINAL_V3.MD (Backend) 2. Estructura de Carpetas (packages/functions) - ACTUALIZADO CON ABSTRACCIONES DE BD
```
packages/functions/ 
â”œâ”€â”€ src/ 
â”‚ â”œâ”€â”€ admin/ 
â”‚ â”‚ â”œâ”€â”€ articleHandlers.ts          # âœ… MIGRADO a abstracciones de BD
â”‚ â”‚ â”œâ”€â”€ adminPriceHandlers.ts       # âœ… MIGRADO a abstracciones de BD
â”‚ â”‚ â”œâ”€â”€ setAdminRole.ts 
â”‚ â”‚ â”œâ”€â”€ siteContentHandlers.ts      # âœ… MIGRADO a abstracciones de BD
â”‚ â”‚ â””â”€â”€ serviceDirectoryHandlers.ts # âœ… MIGRADO a abstracciones de BD
â”‚ â”œâ”€â”€ payments/ 
â”‚ â”‚ â”œâ”€â”€ createCheckout.ts           # âœ… MIGRADO a abstracciones de BD
â”‚ â”‚ â”œâ”€â”€ stripeWebhooks.ts           # âœ… MIGRADO a abstracciones de BD
â”‚ â”‚ â”œâ”€â”€ createStripePortalSession.ts # âœ… MIGRADO a abstracciones de BD
â”‚ â”‚ â””â”€â”€ trackUsage.ts               # âœ… MIGRADO a abstracciones de BD
â”‚ â”œâ”€â”€ recovery/
â”‚ â”‚ â””â”€â”€ analyzeFileRecovery.ts      # âœ… MIGRADO a abstracciones de BD
â”‚ â”œâ”€â”€ proxies/ 
â”‚ â”œâ”€â”€ public/ 
â”‚ â”‚ â””â”€â”€ handleContactForm.ts        # âœ… MIGRADO a abstracciones de BD
â”‚ â””â”€â”€ lib/ 
â”‚     â”œâ”€â”€ database.ts               # ğŸ†• FACTORY SINGLETON para BD
â”‚     â”œâ”€â”€ adapters/
â”‚     â”‚   â””â”€â”€ FirestoreAdapter.ts   # ğŸ†• ADAPTADOR FIRESTORE
â”‚     â””â”€â”€ ...
```

### ğŸ—ï¸ ARQUITECTURA DE ABSTRACCIONES DE BASE DE DATOS - IMPLEMENTADA

**âœ… Estado**: COMPLETAMENTE IMPLEMENTADO Y FUNCIONAL
**âœ… PatrÃ³n**: Adaptador + Factory + Singleton  
**âœ… Objetivo**: Eliminar vendor lock-in, preparar migraciÃ³n futura sin tocar lÃ³gica de negocio
**âœ… VerificaciÃ³n**: âœ… CERO llamadas directas a Firebase fuera de `FirestoreAdapter.ts`

#### ğŸ¯ Arquitectura Implementada

**Tipos Centralizados** (`packages/types/src/database.ts`):
```typescript
export interface IDatabaseAdapter {
  // Operaciones CRUD completas
  getDocument(collection: string, documentId: string): Promise<DatabaseDocument | null>;
  setDocument(collection: string, documentId: string, data: Record<string, any>): Promise<void>;
  updateDocument(collection: string, documentId: string, data: Record<string, any>): Promise<void>;
  deleteDocument(collection: string, documentId: string): Promise<void>;
  
  // Queries y colecciones
  addDocument(collection: string, data: Record<string, any>): Promise<string>;
  queryCollection(collection: string, filters?: QueryFilter[], options?: QueryOptions): Promise<DatabaseDocument[]>;
  
  // Subcolecciones
  getSubDocument(...): Promise<DatabaseDocument | null>;
  setSubDocument(...): Promise<void>;
  addSubDocument(...): Promise<string>;
  
  // Operaciones especiales
  serverTimestamp(): any;
  incrementValue(amount: number): any;
  arrayUnion(elements: any[]): any;
  arrayRemove(elements: any[]): any;
}
```

**Factory Singleton** (`packages/functions/src/lib/database.ts`):
```typescript
// âœ… PUNTO ÃšNICO DE ACCESO EN TODO EL BACKEND
export const database = DatabaseFactory.getInstance().getAdapter();

// âœ… CONFIGURACIÃ“N PARA FUTURAS MIGRACIONES  
export const configureDatabase = (config: DatabaseConfig): void => {
  DatabaseFactory.getInstance().configure(config);
};
```

**Adaptador Firestore** (`packages/functions/src/lib/adapters/FirestoreAdapter.ts`):
- **ğŸ”’ ÃšNICO ARCHIVO que conoce Firebase/Firestore**
- **ğŸ”„ Encapsula TODAS las llamadas directas a Firebase**
- **ğŸ›¡ï¸ Implementa interfaz genÃ©rica IDatabaseAdapter**

#### ğŸ”„ Patrones de MigraciÃ³n Implementados

**âœ… TODAS las Cloud Functions migradas a abstracciones:**

**Antes (Acoplamiento directo a Firebase):**
```typescript
import { getFirestore, FieldValue } from 'firebase-admin/firestore';

const db = getFirestore();
const userDoc = await db.collection('users').doc(uid).get();
if (!userDoc.exists) throw new Error('Usuario no encontrado');

await db.collection('users').doc(uid).update({
  usageCreditsInSeconds: FieldValue.increment(-60),
  lastActivity: FieldValue.serverTimestamp(),
});

await db.collection('users').doc(uid).collection('usageHistory').add({
  serviceType: 'herramientas',
  timestamp: FieldValue.serverTimestamp(),
});
```

**DespuÃ©s (AbstracciÃ³n vendor-agnostic):**
```typescript
import { database } from '../lib/database';

const userDoc = await database.getDocument('users', uid);
if (!userDoc || !userDoc.exists) throw new Error('Usuario no encontrado');

await database.updateDocument('users', uid, {
  usageCreditsInSeconds: database.incrementValue(-60),
  lastActivity: database.serverTimestamp(),
});

await database.addSubDocument('users', uid, 'usageHistory', {
  serviceType: 'herramientas',
  timestamp: database.serverTimestamp(),
});
```

#### ğŸš€ Beneficios Logrados

- **âœ… Eliminar Vendor Lock-in**: Migrar a DynamoDB/MongoDB sin tocar lÃ³gica de negocio
- **âœ… CentralizaciÃ³n**: Todas las operaciones BD en punto Ãºnico `database.ts`
- **âœ… Testabilidad**: Mockear `database` en vez de Firebase completo  
- **âœ… Mantenibilidad**: Cambios BD solo afectan `FirestoreAdapter.ts`
- **âœ… TypeScript Safety**: Tipos centralizados, compilaciÃ³n sin errores
- **âœ… PreparaciÃ³n Futura**: Cambiar proveedor BD modificando solo configuraciÃ³n factory

#### ğŸ”§ Para Futuros Desarrolladores

**âœ… USO CORRECTO en nuevas Cloud Functions:**
```typescript
import { database } from '../lib/database';

// âœ… CORRECTO - Usar abstracciÃ³n
const user = await database.getDocument('users', uid);
await database.updateDocument('users', uid, data);
```

**âŒ PROHIBIDO - No usar Firebase directamente:**
```typescript
// âŒ PROHIBIDO - Acoplamiento directo
import { getFirestore } from 'firebase-admin/firestore';
const db = getFirestore(); // NO HACER ESTO
```

**ğŸ”® MigraciÃ³n Futura a Otro Proveedor:**
1. Implementar nuevo adaptador (ej: `DynamoDBAdapter`)
2. AÃ±adir case en `DatabaseFactory`
3. Cambiar configuraciÃ³n: `configureDatabase({ provider: 'dynamodb' })`
4. **TODO el cÃ³digo sigue funcionando SIN CAMBIOS**

3. Modelo de Datos (Firestore) - ACTUALIZADO

ColecciÃ³n articles: (Sin cambios) ColecciÃ³n users: EXPANDIDO PARA SUSCRIPCIONES

ID: uid de Firebase Authentication Campos:

email (string) createdAt (timestamp) usageCreditsInSeconds (number) - SISTEMA DE PAGO POR HORAS IMPLEMENTADO

ColecciÃ³n professionalServices:

ID: Autogenerado Campos: name (string), website (string), description (string), logoUrl (string),
specialties (array), isVerified (boolean).

ColecciÃ³n siteContent:

ID del Documento: homepage Campos: bannerImageUrl (string), bannerTitle_es (string), bannerTitle_en
(string), bannerSubtitle_es (string), bannerSubtitle_en (string), bannerButtonText_es (string),
bannerButtonText_en (string), bannerButtonLink (string).

ColecciÃ³n contactSubmissions:

ID: Autogenerado Campos: name (string), email (string), message (string), submittedAt (timestamp),
status ('new' | 'read').

4.  Reglas de Seguridad (Firestore) - ACTUALIZADO textrules_version = '2'; service cloud.firestore {
    match /databases/{database}/documents { match /articles/{articleId} { ... } match
    /users/{userId} { allow read, write: if request.auth != null && request.auth.uid == userId;
    allow create: if request.auth != null && request.auth.uid == userId; // Solo admins pueden leer
    datos de otros usuarios allow read: if request.auth.token.admin == true; }

        // Cualquiera puede leer los servicios, solo los admins pueden escribir
        match /professionalServices/{serviceId} {
          allow read: if true;
          allow write: if request.auth.token.admin == true;
        }
        // Cualquiera puede leer el contenido de la home, solo admins pueden escribir
        match /siteContent/homepage {
          allow read: if true;
          allow write: if request.auth.token.admin == true;
        }
        // Cualquiera puede crear un envÃ­o de contacto, pero nadie puede leerlos
        match /contactSubmissions/{submissionId} {
          allow read, write: if false;
          allow create: if true;
        }

    } }

5.  Nuevas Cloud Functions para AutenticaciÃ³n y Suscripciones 5.1. createStripePortalSession.ts

PropÃ³sito: Crear sesiÃ³n del Portal de Cliente de Stripe AutenticaciÃ³n: Usuario autenticado
Ãºnicamente Flujo:

Verificar autenticaciÃ³n del usuario Crear sesiÃ³n
del portal con Stripe SDK Retornar URL de redirecciÃ³n segura

5.2. Webhook de Stripe (stripeWebhooks.ts) - EXPANDIDO

Eventos nuevos a manejar:

checkout.session.completed â†’ Sumar segundos comprados a usageCreditsInSeconds

Actualizaciones automÃ¡ticas del documento de usuario en Firestore

5.3. Middleware de AutenticaciÃ³n Frontend

Archivo: middleware.ts (Next.js) Rutas protegidas: /(dashboard)/\* RedirecciÃ³n: No autenticado â†’
/login

6. Mejoras Implementadas para Robustez y ProducciÃ³n 2025 A. GestiÃ³n de Costos en Serverless

DescripciÃ³n: En funciones como handleContactForm.ts y proxies, integrar Redis (via Upstash o Google
Memorystore) para cachÃ© de respuestas frecuentes a APIs externas, con TTL de 5min. AÃ±adir en lib/ un
mÃ³dulo cache.ts para manejar get/set sin alterar flujos existentes.

B. MÃ©tricas de Rendimiento

DescripciÃ³n: En todas las Cloud Functions, aÃ±adir integraciÃ³n con Google Cloud Monitoring: Usar
@google-cloud/logging para registrar mÃ©tricas de latencia y errores. Configurar alertas para
umbrales >500ms. AÃ±adir en cada handler: const logger = new Logging();
logger.logStructured({message: 'Execution time', duration: ms});.

C. ReestructuraciÃ³n a Pago por Horas

DescripciÃ³n: Sistema completamente basado en usageCreditsInSeconds (number) para crÃ©ditos en segundos - modelo de pago por horas implementado. Adaptar Stripe para compras Ãºnicas de
paquetes de horas (ej. checkout.session.completed suma segundos). Nueva funciÃ³n trackUsage.ts:
Descuenta segundos en tiempo real durante uso de herramientas/chatbot, trigger por eventos de
usuario. CrÃ©ditos iniciales en registro: 900s (15min) para herramientas, 1800s (30min) para chatbot.

D. GestiÃ³n de Precios en Admin

DescripciÃ³n: Nueva funciÃ³n adminPriceHandlers.ts para actualizar tarifas (4.99â‚¬/h primeras 2h,
3.99â‚¬/h siguientes) y paquetes de horas, almacenados en Firestore (colecciÃ³n siteConfig/pricing).
