üóÑÔ∏è PROYEC_PARTE3_FINAL_V3.MD (Backend) 2. Estructura de Carpetas (packages/functions) - ACTUALIZADO
text/packages/functions/ ‚îú‚îÄ‚îÄ src/ ‚îÇ ‚îú‚îÄ‚îÄ admin/ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ articleHandlers.ts ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ setAdminRole.ts ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ siteContentHandlers.ts # Para gestionar el contenido de la home ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ
serviceDirectoryHandlers.ts # Para gestionar el directorio ‚îÇ ‚îú‚îÄ‚îÄ payments/ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ createCheckout.ts
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ stripeWebhooks.ts ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ createStripePortalSession.ts # **NUEVO** Para gesti√≥n de
suscripciones ‚îÇ ‚îú‚îÄ‚îÄ proxies/ ‚îÇ ‚îú‚îÄ‚îÄ public/ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ handleContactForm.ts # Para el formulario de
contacto ‚îÇ ‚îî‚îÄ‚îÄ lib/ ... 3. Modelo de Datos (Firestore) - ACTUALIZADO

Colecci√≥n articles: (Sin cambios) Colecci√≥n users: EXPANDIDO PARA SUSCRIPCIONES

ID: uid de Firebase Authentication Campos:

email (string) createdAt (timestamp) hasPremiumAccess (boolean) - NUEVO CAMPO CLAVE stripeCustomerId
(string) - NUEVO Para integraci√≥n con Stripe subscriptionStatus ('active' | 'canceled' | 'past_due'
| null) - NUEVO subscriptionId (string) - NUEVO ID de suscripci√≥n de Stripe

Colecci√≥n professionalServices:

ID: Autogenerado Campos: name (string), website (string), description (string), logoUrl (string),
specialties (array), isVerified (boolean).

Colecci√≥n siteContent:

ID del Documento: homepage Campos: bannerImageUrl (string), bannerTitle_es (string), bannerTitle_en
(string), bannerSubtitle_es (string), bannerSubtitle_en (string), bannerButtonText_es (string),
bannerButtonText_en (string), bannerButtonLink (string).

Colecci√≥n contactSubmissions:

ID: Autogenerado Campos: name (string), email (string), message (string), submittedAt (timestamp),
status ('new' | 'read').

4.  Reglas de Seguridad (Firestore) - ACTUALIZADO textrules_version = '2'; service cloud.firestore {
    match /databases/{database}/documents { match /articles/{articleId} { ... } match
    /users/{userId} { allow read, write: if request.auth != null && request.auth.uid == userId;
    allow create: if request.auth != null && request.auth.uid == userId; // Solo admins pueden leer
    datos de otros usuarios allow read: if request.auth.token.admin == true; }

        // Cualquiera puede leer los servicios, solo los admins pueden escribir
        match /professionalServices/{serviceId} {
          allow read: if true;
          allow write: if request.auth.token.admin == true;
        }
        // Cualquiera puede leer el contenido de la home, solo admins pueden escribir
        match /siteContent/homepage {
          allow read: if true;
          allow write: if request.auth.token.admin == true;
        }
        // Cualquiera puede crear un env√≠o de contacto, pero nadie puede leerlos
        match /contactSubmissions/{submissionId} {
          allow read, write: if false;
          allow create: if true;
        }

    } }

5.  Nuevas Cloud Functions para Autenticaci√≥n y Suscripciones 5.1. createStripePortalSession.ts

Prop√≥sito: Crear sesi√≥n del Portal de Cliente de Stripe Autenticaci√≥n: Usuario autenticado
√∫nicamente Flujo:

Verificar autenticaci√≥n del usuario Obtener stripeCustomerId del documento del usuario Crear sesi√≥n
del portal con Stripe SDK Retornar URL de redirecci√≥n segura

5.2. Webhook de Stripe (stripeWebhooks.ts) - EXPANDIDO

Eventos nuevos a manejar:

customer.subscription.created ‚Üí hasPremiumAccess: true customer.subscription.updated ‚Üí Actualizar
estado de suscripci√≥n customer.subscription.deleted ‚Üí hasPremiumAccess: false

Actualizaciones autom√°ticas del documento de usuario en Firestore

5.3. Middleware de Autenticaci√≥n Frontend

Archivo: middleware.ts (Next.js) Rutas protegidas: /(dashboard)/\* Redirecci√≥n: No autenticado ‚Üí
/login

6. Mejoras Implementadas para Robustez y Producci√≥n 2025 A. Gesti√≥n de Costos en Serverless

Descripci√≥n: En funciones como handleContactForm.ts y proxies, integrar Redis (via Upstash o Google
Memorystore) para cach√© de respuestas frecuentes a APIs externas, con TTL de 5min. A√±adir en lib/ un
m√≥dulo cache.ts para manejar get/set sin alterar flujos existentes.

B. M√©tricas de Rendimiento

Descripci√≥n: En todas las Cloud Functions, a√±adir integraci√≥n con Google Cloud Monitoring: Usar
@google-cloud/logging para registrar m√©tricas de latencia y errores. Configurar alertas para
umbrales >500ms. A√±adir en cada handler: const logger = new Logging();
logger.logStructured({message: 'Execution time', duration: ms});.

C. Reestructuraci√≥n a Pago por Horas

Descripci√≥n: Eliminar hasPremiumAccess, subscriptionStatus, subscriptionId. A√±adir
usageCreditsInSeconds (number) para cr√©ditos en segundos. Adaptar Stripe para compras √∫nicas de
paquetes de horas (ej. checkout.session.completed suma segundos). Nueva funci√≥n trackUsage.ts:
Descuenta segundos en tiempo real durante uso de herramientas/chatbot, trigger por eventos de
usuario. Cr√©ditos iniciales en registro: 900s (15min) para herramientas, 1800s (30min) para chatbot.

D. Gesti√≥n de Precios en Admin

Descripci√≥n: Nueva funci√≥n adminPriceHandlers.ts para actualizar tarifas (4.99‚Ç¨/h primeras 2h,
3.99‚Ç¨/h siguientes) y paquetes de horas, almacenados en Firestore (colecci√≥n siteConfig/pricing).
