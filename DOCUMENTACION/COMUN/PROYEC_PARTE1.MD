<DOCUMENT filename="PROYEC_PARTE1.MD">
üèóÔ∏è PROYECTO: Br√∫jula Cripto - Arquitectura Global Unificada (VERSI√ìN FINAL DE PRODUCCI√ìN)

1. Filosof√≠a del Proyecto
Este proyecto se construye sobre cinco pilares innegociables:

Estructura Centralizada: Un √∫nico repositorio (monorepo) para todo el c√≥digo, gestionado con pnpm workspaces, para forzar la compartici√≥n de l√≥gica y tipos.
Consistencia Forzada: Herramientas de linting (ESLint) y formato (Prettier) con reglas estrictas para que todo el c√≥digo parezca escrito por una sola persona.
Escalabilidad por Dise√±o: Arquitectura desacoplada que permite que cada parte del sistema crezca de forma independiente.
Dualidad Funcional: Una plataforma con una cara p√∫blica para los usuarios y un potente panel de administraci√≥n seguro para la gesti√≥n interna.
Experiencia de Usuario Universal: Soporte nativo para m√∫ltiples idiomas (espa√±ol e ingl√©s), modos de visualizaci√≥n (claro y oscuro) y un dise√±o 100% adaptable a dispositivos m√≥viles (Mobile-First).

2. Estructura del Monorepo
text/br√∫jula-cripto/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ app/              # El frontend Next.js (p√∫blico + admin)
‚îÇ   ‚îú‚îÄ‚îÄ functions/        # El backend (Cloud Functions)
‚îÇ   ‚îú‚îÄ‚îÄ microservice-ia/  # El microservicio de contenido
‚îÇ   ‚îî‚îÄ‚îÄ types/            # Paquete COMPARTIDO de tipos de TypeScript
‚îú‚îÄ‚îÄ .eslintrc.json        # Reglas de linting para TODO el proyecto
‚îú‚îÄ‚îÄ .prettierrc           # Reglas de formato para TODO el proyecto
‚îî‚îÄ‚îÄ pnpm-workspace.yaml   # Define los paquetes del monorepo
Ventaja Cr√≠tica: El paquete packages/types es la √∫nica fuente de verdad para los modelos de datos (IArticle, IUser). Todos los dem√°s paquetes lo importan. Esto elimina por completo los errores de inconsistencia de datos entre el frontend, el backend y los servicios.
3. Mejoras Implementadas para Robustez y Producci√≥n 2025
A. Proceso de Actualizaci√≥n para packages/types

Descripci√≥n: Para mitigar rigidez, se establece un proceso estricto: Cualquier actualizaci√≥n a tipos (ej. a√±adir campos) requiere un changelog en /packages/types/CHANGELOG.md, pruebas automatizadas con Jest para validar compatibilidad retroactiva, y revisi√≥n por pares antes de merge. Esto se integra en el flujo de trabajo sin alterar tipos existentes.

B. Integraci√≥n de CI/CD

Descripci√≥n: Se a√±ade pipeline de CI/CD usando Google Cloud Build para automatizar pruebas, linting (ESLint), formato (Prettier), y despliegues. Triggers en pushes a main: Ejecuta pnpm test, pnpm lint, y despliega a Cloud Run/Functions si pasa. Configuraci√≥n en cloudbuild.yaml en ra√≠z del monorepo.

C. Mitigaci√≥n de Vendor Lock-in

Descripci√≥n: Se eval√∫an alternativas modulares: Para Firestore, preparar abstracciones con interfaces en packages/types que permitan swap a DynamoDB si necesario. Para Cloud Run, usar contenedores Docker est√°ndar para portabilidad a ECS. No se altera dependencia actual, solo se a√±ade secci√≥n de evaluaci√≥n en documentaci√≥n.

D. Adaptaci√≥n al Modelo de Monetizaci√≥n por Horas

Descripci√≥n: El sistema de monetizaci√≥n se actualiza a un modelo de pago por uso basado en cr√©ditos de tiempo (usageCreditsInSeconds). Esto se integra en todos los paquetes mediante tipos compartidos en packages/types, asegurando consistencia. Las abstracciones permiten futuras expansiones sin romper la arquitectura existente.

# üìÇ packages/app (Frontend Next.js) - Documentaci√≥n Detallada por Carpetas

## 1. Estructura General de packages/app

Esta carpeta contiene el frontend completo de la aplicaci√≥n Next.js, incluyendo rutas p√∫blicas, protegidas, componentes, y l√≥gica de API. Se sigue una estructura estricta basada en App Router de Next.js 14+, con soporte para i18n (espa√±ol/ingl√©s), temas (claro/oscuro), y dise√±o mobile-first. Todos los componentes usan TypeScript en modo strict, Tailwind CSS para estilos, y importan tipos desde @br√∫jula-cripto/types.

### packages/app/app/

- **[locale]/**: Rutas localizadas para i18n.
  - **(main)/**: Rutas p√∫blicas principales.
    - **layout.tsx**: Layout principal para rutas p√∫blicas, incluye Navbar.tsx y Footer.tsx.
    - **page.tsx**: P√°gina de Inicio (Home), renderiza HomepageBanner.tsx, FeaturedPostsCarousel.tsx, ValueProposition.tsx, y FeedbackButton.tsx (solo para suscritos).
    - **blog/**:
      - **page.tsx**: P√°gina del Blog, incluye BlogPage.tsx con banner editable, BlogSearchBar.tsx, ArticleList.tsx, y PaginationControls.tsx.
      - **[slug]/page.tsx**: P√°gina de Art√≠culo Individual, usa ArticlePage.tsx con contenido Markdown, tags clicables, navegaci√≥n anterior/siguiente, sharing (Web Share API), likes/comentarios (solo suscritos).
    - **recuperacion/**:
      - **page.tsx**: P√°gina de Diagn√≥stico Interactivo, usa RecoveryWizard.tsx con tarjetas enlazadas a herramientas.
      - **password/page.tsx**: P√°gina de Recuperaci√≥n de Contrase√±a, usa WasmPasswordEngine.tsx con formulario para datos (diccionarios), niveles gratuito/premium, progreso, y resultados.
    - **herramientas/**:
      - **tracker/page.tsx**: P√°gina de Rastreador de Transacciones, usa TransactionTracker.tsx con formulario para hash/direcci√≥n y resultados de APIs externas.
      - **servicios/page.tsx**: P√°gina de Directorio de Servicios, usa ServiceDirectory.tsx con lista filtrable por especialidad.
    - **contacto/**:
      - **page.tsx**: P√°gina de Contacto, usa ContactForm.tsx para enviar nombre/email/mensaje v√≠a Cloud Function.
    - **seguridad/**:
      - **page.tsx**: P√°gina de Gu√≠as de Seguridad, usa SecurityGuides.tsx con blog filtrado por categor√≠a "seguridad".
    - **registro/**:
      - **page.tsx**: P√°gina de Registro, usa SignUpForm.tsx con campos email/contrase√±a, validaci√≥n (checkbox para t√©rminos/privacidad), post-registro redirecciona a /cuenta.
    - **login/**:
      - **page.tsx**: P√°gina de Inicio de Sesi√≥n, usa SignInForm.tsx con email/contrase√±a y Google OAuth (signInWithPopup).
    - **recuperar-password/**:
      - **page.tsx**: P√°gina de Recuperaci√≥n de Contrase√±a de Cuenta, usa PasswordResetForm.tsx para enviar email de reset v√≠a Firebase Auth.
    - **suscripcion/**:
      - **page.tsx**: P√°gina de Suscripci√≥n, usa PricingPage.tsx con tabla de precios (gratuito vs premium), CompetitorComparison.tsx (tabs interactivos, calculadora para costos con inputs monto/horas, comparaci√≥n escalonada vs 20% competidores), y UpgradeButton.tsx con checkbox obligatorio para t√©rminos/descargo.
    - **legal/**:
      - **aviso-legal/page.tsx**: P√°gina de Aviso Legal, texto est√°tico.
      - **privacidad/page.tsx**: P√°gina de Pol√≠tica de Privacidad, texto est√°tico.
      - **terminos/page.tsx**: P√°gina de T√©rminos y Condiciones, texto est√°tico.
      - **descargo-responsabilidad/page.tsx**: P√°gina de Descargo de Responsabilidad, texto enorme y claro sobre no garant√≠as, responsabilidad del usuario, enlaces visibles en footer y √°reas de pago/riesgo.
    - **chatbot/**:
      - **page.tsx**: P√°gina del Chatbot, usa ChatbotUI.tsx con logo br√∫jula, lista de conversaciones, respuestas streaming, sugerencias, render components (tablas/tarjetas), y ConversationList.tsx.
  - **(dashboard)/**: Rutas protegidas (middleware.ts verifica autenticaci√≥n).
    - **layout.tsx**: Layout para √°rea protegida, incluye navegaci√≥n adaptativa.
    - **cuenta/**:
      - **page.tsx**: Panel de Control del Usuario, usa UserDashboard.tsx con pesta√±as para suscripci√≥n (tiempo restante H:M:S, historial compras), portal Stripe, y estado premium.
  - **not-found.tsx**: P√°gina de Error 404, usa NotFoundPage.tsx con imagen amigable y mensaje.
- **admin/**: Rutas de administraci√≥n (protegidas por /admin/auth).
  - **auth/page.tsx**: P√°gina de Login de Admin.
  - **page.tsx**: Dashboard de Admin, vista general de art√≠culos, borradores, estad√≠sticas.
  - **articles/**:
    - **page.tsx**: Gesti√≥n de Art√≠culos, usa ArticleDataTable.tsx para ver/filtrar/editar/eliminar, bot√≥n para nuevo art√≠culo.
    - **[id]/page.tsx**: Editor de Art√≠culos, usa ArticleEditor.tsx con TipTap para contenido, estado (Borrador/Publicado), enlaces afiliado, imagen portada; opciones IA (prompt Gemini/DALL-E, tama√±o palabras, profundidad, Q&A/conclusiones).
  - **homepage/page.tsx**: Gesti√≥n de Contenido de la Home, editor para banner (subir imagen, texto, bot√≥n).
  - **feedback/page.tsx**: Gesti√≥n de Mensajes de Feedback, tabla para ver/eliminar (individual/masiva).
  - **comments/page.tsx**: Moderaci√≥n de Comentarios, vista para ver/eliminar, integraci√≥n IA autom√°tica.
  - **users/page.tsx**: Gesti√≥n de Usuarios, lista con estado, saldo usageCreditsInSeconds (H:M:S), filtros/exportaci√≥n.

### packages/app/components/

- **ui/**: Componentes reutilizables (ej. Button.tsx, Card.tsx).
- **layout/**: Componentes de layout (ej. Navbar.tsx con enlaces, selector idioma/tema; Footer.tsx con columnas navegaci√≥n/legal/contacto, acorde√≥n m√≥vil para legales).
- **features/**:
  - **admin/**: Componentes para admin (ej. ArticleDataTable.tsx, ArticleEditor.tsx).
  - **recovery/**: RecoveryWizard.tsx, WasmPasswordEngine.tsx (con reintentos retry-axios, niveles premium).
  - **blog/**: ArticleCard.tsx (imagen, t√≠tulo, excerpt, tags, sharing, likes/comentarios), ArticleList.tsx, BlogSearchBar.tsx, PaginationControls.tsx.
  - **payments/**: PricingTier.tsx, UpgradeButton.tsx (con checkbox obligatorio), CompetitorComparison.tsx (tabs, calculadora interactiva).
  - **homepage/**: HomepageBanner.tsx (editable desde admin), FeaturedPostsCarousel.tsx, ValueProposition.tsx, FeedbackButton.tsx (flotante, modal para mensaje).
  - **tools/**: TransactionTracker.tsx (formulario, resultados APIs, reintentos), ServiceDirectory.tsx (lista filtrable).
  - **contact/**: ContactForm.tsx (con feedback errores localizados via react-hook-form).
  - **auth/**: SignUpForm.tsx, SignInForm.tsx (con Google OAuth mapeo uid a stripeCustomerId), PasswordResetForm.tsx (con feedback).
  - **pricing/**: PricingPage.tsx.
  - **dashboard/**: UserDashboard.tsx.

### packages/app/lib/

- **api.ts**: L√≥gica para llamadas a backend (Cloud Functions), microservicios (IA, chatbot), y APIs externas; incluye trackUsage para descuento de cr√©ditos en tiempo real.

### packages/app/middleware.ts

- Middleware de Next.js para proteger rutas /(dashboard)/*y /admin/*, redirecciona a /login si no autenticado.

### Mejoras para Producci√≥n 2025 en packages/app

- Escalabilidad: Reintentos con backoff en TransactionTracker.tsx (retry-axios, max 3, delay 1s).
- Pruebas A/B: En RecoveryWizard.tsx, variar texto/orden con Vercel/Optimizely, m√©tricas en Firestore.
- Pago por Horas: Contadores reales en WasmPasswordEngine.tsx, ChatbotUI.tsx; cr√©ditos iniciales (900s herramientas, 1800s chatbot).
- SEO: Metadata API en todas las p√°ginas, JSON-LD para articles.
- Usabilidad: Mensajes de error localizados en formularios (react-hook-form); dise√±o discreto en footer (acorde√≥n Tailwind m√≥vil).
- Optimizaci√≥n: Compresi√≥n im√°genes con Sharp, soporte AVIF en next/image; Google Analytics para engagement (eventos en CTAs).

# üìÇ packages/functions (Backend Cloud Functions) - Documentaci√≥n Detallada por Carpetas

## 1. Estructura General de packages/functions

Esta carpeta contiene el backend serverless con Google Cloud Functions, gestionando autenticaci√≥n, pagos, proxies, y handlers administrativos. Usa TypeScript, importa tipos desde @br√∫jula-cripto/types, y se integra con Firestore, Stripe, y Redis para cach√©.

### packages/functions/src/

- **admin/**:
  - **articleHandlers.ts**: Handlers para CRUD de art√≠culos (crear/editar/eliminar/publicar), integraci√≥n IA para moderaci√≥n comentarios.
  - **setAdminRole.ts**: Asigna rol admin a usuarios.
  - **siteContentHandlers.ts**: Handlers para editar contenido de homepage (banner, etc.), almacenado en siteContent/homepage.
  - **serviceDirectoryHandlers.ts**: CRUD para professionalServices (name, website, description, logoUrl, specialties, isVerified).
  - **priceHandlers.ts**: Actualizar tarifas y paquetes de horas en siteConfig/pricing.
- **payments/**:
  - **createCheckout.ts**: Crea sesi√≥n de checkout Stripe para paquetes de horas (compras √∫nicas).
  - **stripeWebhooks.ts**: Maneja eventos Stripe (checkout.session.completed suma usageCreditsInSeconds; subscription.created/updated/deleted actualiza campos user).
  - **createStripePortalSession.ts**: Crea sesi√≥n portal Stripe para gesti√≥n (facturaci√≥n, cancelaci√≥n), verifica autenticaci√≥n y stripeCustomerId.
- **proxies/**: Proxies para APIs externas (ej. Covalent, Moralis), con cach√© Redis (TTL 5min) via cache.ts.
- **public/**:
  - **handleContactForm.ts**: Procesa env√≠os de contacto, guarda en contactSubmissions (name, email, message, submittedAt, status).
- **lib/**:
  - **cache.ts**: M√≥dulo para get/set en Redis (Upstash/Memorystore) para respuestas frecuentes.
  - **trackUsage.ts**: Descuenta usageCreditsInSeconds en tiempo real durante uso de herramientas/chatbot, trigger por eventos usuario.

### packages/functions/firestore.rules

- Reglas de seguridad: Users solo escribibles por owner/admin; professionalServices/sitContent le√≠bles por todos, escribibles por admin; contactSubmissions solo creables; articles como definido.

### packages/functions/cloudbuild.yaml

- Pipeline CI/CD: Triggers en main, ejecuta pnpm test/lint, despliega a Cloud Functions/Run si pasa.

### Modelo de Datos en Firestore

- **users/**: uid, email, createdAt, usageCreditsInSeconds (inicial 900s herramientas + 1800s chatbot), stripeCustomerId.
- **articles/**: Como definido, con status 'draft'/published, source 'ai-generated'.
- **professionalServices/**: name, website, description, logoUrl, specialties, isVerified.
- **siteContent/**: homepage con bannerImageUrl, bannerTitle_es/en, etc.
- **contactSubmissions/**: name, email, message, submittedAt, status.
- **siteConfig/**: pricing con tarifas (4.99‚Ç¨/h primeras 2h, 3.99‚Ç¨/h siguientes).
- **chatbot_conversations/**: userId, title, isFavorite, createdAt, updatedAt; subcolecci√≥n messages: role, content, timestamp.

### Mejoras para Producci√≥n 2025 en packages/functions

- Gesti√≥n Costos: Cach√© Redis en proxies para APIs externas.
- M√©tricas: Integraci√≥n Google Cloud Monitoring/Logging en handlers (latencia, errores, alertas >500ms).
- Pago por Horas: Eliminados hasPremiumAccess/subscription*; focus en usageCreditsInSeconds, trackUsage para descuento.
- Mitigaci√≥n Vendor Lock-in: Abstracciones en types para swap Firestore/DynamoDB, Docker est√°ndar para portabilidad.

# üìÇ packages/microservice-ia (Microservicio de Contenido IA) & packages/types - Documentaci√≥n Detallada

## 1. Estructura General de packages/microservice-ia

Microservicio independiente en Google Cloud Run (Docker), usa Genkit for Firebase, Gemini Pro (Vertex AI), trigger por Cloud Scheduler. Genera contenido IA, modera comentarios, soporta i18n.

### packages/microservice-ia/src/

- **flows/**:
  - **fetch-news.ts**: Herramienta newsApiTool, fallback a temas evergreen si falla.
  - **generate-content-es.ts**: Genera title/contentMarkdown/excerpt en espa√±ol.
  - **generate-content-en.ts**: Genera en ingl√©s.
  - **generate-seo-metadata.ts**: Genera slug √∫nico, category, tags, metaetiquetas SEO (title/description/keywords, schema.org).
  - **check-slug-uniqueness.ts**: Consulta Firestore para unicidad, a√±ade sufijo si existe.
  - **assemble-and-validate.ts**: Construye IArticle, valida con Zod.
  - **save-to-firestore.ts**: Guarda en articles con status 'draft', source 'ai-generated'.
  - **moderateComment.ts**: Analiza comentarios con OpenAI Moderation/Google Perspective, marca/elimina basado en config admin.
- **prompts/**: Archivos .txt centralizados para prompts Gemini (formateados para es/en).
- **tools/**: getWalletAnalysis, getTransactionStatus, getContractAuditSummary (integraci√≥n APIs: Covalent, Moralis, GoPlus).

### packages/microservice-ia/Dockerfile

- Contenedor est√°ndar para Cloud Run, inyecta secretos via Google Secret Manager (claves Vertex AI).

### Endpoints API

- GET /articles?siteKey=xxx: Para embed externo, verifica key en Firestore, limita por quota.
- POST /conversations, etc.: Para chatbot (streaming), l√≠mites gratuitos (10 msg/d√≠a), chequeo usageCreditsInSeconds.

### Mejoras para Producci√≥n 2025 en packages/microservice-ia

- Optimizaci√≥n: Post-indexaci√≥n en Vertex AI, limpieza semanal via Scheduler, logging de tama√±o √≠ndice.
- Validaci√≥n: Audit-responses post-Zod para precisi√≥n t√©cnica (score <90% a manual).
- Generaci√≥n SEO: Din√°mica para 2025 (mobile-first indexing), opciones admin para foto/afiliado/programaci√≥n.
- Moderaci√≥n: Autom√°tica en comentarios, config en Firestore.
- Uso Externo: Endpoints monetizados con siteKey.
- Pago por Horas: Chequeo credits en endpoints, upselling si bajos.

## 2. Estructura de packages/types

- **index.ts**: Tipos compartidos (IArticle, IUser con usageCreditsInSeconds, IChatConversation, IChatMessage).
- **CHANGELOG.md**: Registro de actualizaciones, pruebas Jest para compatibilidad retroactiva.

## Ra√≠z del Monorepo

- **pnpm-workspace.yaml**: Define paquetes.
- **.eslintrc.json**: Reglas estrictas para todo.
- **.prettierrc**: Formato consistente.
- **cloudbuild.yaml**: CI/CD global.
